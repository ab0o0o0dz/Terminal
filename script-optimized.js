// Local Authentication System (No Firebase needed)
let currentUser=null,currentForm=null,signatureCanvas=null,signatureCtx=null,isDrawing=false;
let documents=JSON.parse(localStorage.getItem('documents'))||[],users=JSON.parse(localStorage.getItem('users'))||[],signatures=JSON.parse(localStorage.getItem('signatures'))||[];
function loadUsersFromStorage(){try{const e=localStorage.getItem('users');users=e?JSON.parse(e):[]}catch(e){console.error('Error loading users:',e),users=[]}window.users=users}
loadUsersFromStorage(),console.log('Users loaded on page load:',users);
const permissions={'admin':{'forms':['create','read','update','delete','print'],'documents':['create','read','update','delete','print','download'],'signatures':['create','read','update','delete','unify'],'users':['create','read','update','delete'],'system':['monitor','logs','settings']},'user':{'forms':['create','read','print'],'documents':['read','print'],'signatures':['read'],'users':[],'system':[]}};
const militaryRanks={officers:['ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'],enlisted:['جندي','جندي أول','عريف','وكيل رقيب','رقيب','رقيب أول','رئيس رقباء']};
const commanderInfo={name:'عبدالله الزهراني',rank:'مقدم',position:'قائد فرقة N3',unit:'قسم العمليات وزارة الداخلية'};
if(0===users.length){users.push({id:1,fullName:'مدير النظام',username:'admin',password:'admin123456',role:'admin',permissions:{'forms':['create','read','update','delete','print'],'documents':['create','read','update','delete','print','download'],'signatures':['create','read','update','delete','unify'],'users':['create','read','update','delete'],'system':['monitor','logs','settings']},isActive:!0,createdAt:new Date().toISOString()}),localStorage.setItem('users',JSON.stringify(users)),console.log('Default admin user created')}
loadUsersFromStorage();
if(0===signatures.length){signatures.push({id:1,name:'التوقيع الافتراضي',data:'',isDefault:!0,createdAt:new Date().toISOString()}),localStorage.setItem('signatures',JSON.stringify(signatures))}
document.addEventListener('DOMContentLoaded',function(){window.location.pathname.includes('login.html')||window.location.pathname.includes('register.html')||checkLoginStatus(),initializeSignatureCanvas(),loadDocuments(),loadUsers(),loadSignatures(),addFormValidation()});
function addFormValidation(){document.addEventListener('input',function(e){'INPUT'===e.target.tagName||'SELECT'===e.target.tagName||'TEXTAREA'===e.target.tagName?(e.target.hasAttribute('required')&&!e.target.value.trim()?e.target.style.borderColor='#dc3545':e.target.style.borderColor='#e0e0e0'):void 0})}
function logout(){currentUser=null,sessionStorage.removeItem('currentUser'),localStorage.removeItem('currentUser'),showMessage('تم تسجيل الخروج بنجاح','success'),setTimeout(()=>{window.location.href='login.html'},1500)}
function checkLoginStatus(){if(window.location.pathname.includes('login.html')||window.location.pathname.includes('register.html'))return;const e=sessionStorage.getItem('currentUser');e?function(){try{currentUser=JSON.parse(e),showDashboard(),updateUIForPermissions()}catch(e){console.error('Error:',e),redirectToLogin()}}():redirectToLogin()}
function redirectToLogin(){sessionStorage.removeItem('currentUser'),localStorage.removeItem('currentUser');const e=document.getElementById('loginRedirect');e&&(e.style.display='flex',document.getElementById('dashboard').style.display='none')}
function showDashboard(){document.getElementById('loginRedirect').style.display='none',document.getElementById('dashboard').style.display='block',document.getElementById('userInfo').style.display='flex';const e=document.getElementById('userName');e&&(e.textContent=currentUser.fullName||currentUser.displayName||'مستخدم')}
function showSection(e){document.querySelectorAll('.section').forEach(e=>e.classList.remove('active')),document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')),document.getElementById(e+'Section').classList.add('active'),event.target.classList.add('active');switch(e){case'documents':loadDocuments();break;case'users':loadUsersFromStorage(),loadUsers();break;case'signatures':loadSignatures()}}
function openForm(e){checkPermission('forms','create')||(currentForm=e,document.getElementById('formModal').style.display='block',document.getElementById('formContent').innerHTML='absence'===e?generateAbsenceForm():generateHandoverForm(),setTimeout(()=>{addHijriDateToForm()},100))}
function generateAbsenceForm(){return`<div class="form-header"><div class="logo-section"><img src="logo.svg" alt="شعار" class="logo"></div><div class="title-section"><h1>المملكة العربية السعودية</h1><h2>وزارة الداخلية</h2><h3>نموذج تأخير أو غياب</h3></div></div><div class="form-group"><label>الاسم:</label><input type="text" name="name" required></div><div class="form-group"><label>الرتبة:</label><select name="rank" required><option>اختر</option>${militaryRanks.officers.map(e=>`<option>${e}</option>`).join('')}${militaryRanks.enlisted.map(e=>`<option>${e}</option>`).join('')}</select></div><div class="form-group"><label>الرقم العسكري:</label><input type="text" name="militaryNumber" required></div><div class="form-group"><label>السبب:</label><textarea name="reason" required></textarea></div>`}
function generateHandoverForm(){return`<div class="form-header"><div class="logo-section"><img src="logo.svg" alt="شعار" class="logo"></div><div class="title-section"><h1>المملكة العربية السعودية</h1><h2>وزارة الداخلية</h2><h3>نموذج تأخير استلام</h3></div></div><div class="form-group"><label>الاسم:</label><input type="text" name="name" required></div><div class="form-group"><label>الرتبة:</label><select name="rank" required><option>اختر</option>${militaryRanks.officers.map(e=>`<option>${e}</option>`).join('')}${militaryRanks.enlisted.map(e=>`<option>${e}</option>`).join('')}</select></div><div class="form-group"><label>الرقم العسكري:</label><input type="text" name="militaryNumber" required></div><div class="form-group"><label>السبب:</label><textarea name="reason" required></textarea></div>`}
function closeForm(){document.getElementById('formModal').style.display='none',currentForm=null}
function saveForm(){checkPermission('forms','create')||(currentForm=null,showMessage('تم حفظ النموذج بنجاح','success'),closeForm())}
function printForm(){checkPermission('forms','print')||(window.print&&window.print())}
function loadDocuments(){checkPermission('documents','read')||(document.getElementById('documentsList').innerHTML='<p style="text-align:center">لا توجد مستندات</p>')}
function loadUsers(){checkPermission('users','read')||(loadUsersFromStorage(),document.getElementById('usersList').innerHTML=users.map((e,t)=>`<div class="user-card"><h3>${e.fullName}</h3><p>${e.username}</p></div>`).join(''))}
function addUser(){checkPermission('users','create')||(document.getElementById('userModal').style.display='block')}
function closeUserModal(){document.getElementById('userModal').style.display='none'}
function saveUser(){checkPermission('users','create')&&checkPermission('users','update')||(showMessage('تم حفظ المستخدم','success'),closeUserModal())}
function initializeSignatureCanvas(){(signatureCanvas=document.getElementById('signatureCanvas'))&&(signatureCtx=signatureCanvas.getContext('2d'),signatureCtx.strokeStyle='#000',signatureCtx.lineWidth=2)}
function addSignature(){checkPermission('signatures','create')||(document.getElementById('signatureModal').style.display='block')}
function closeSignatureModal(){document.getElementById('signatureModal').style.display='none'}
function clearSignature(){signatureCtx&&signatureCtx.clearRect(0,0,signatureCanvas.width,signatureCanvas.height)}
function saveSignature(){checkPermission('signatures','create')||(showMessage('تم حفظ التوقيع','success'),closeSignatureModal())}
function loadSignatures(){checkPermission('signatures','read')||(document.getElementById('signaturePreview').innerHTML='<p>لا يوجد توقيع</p>')}
function showTerms(){alert('شروط الاستخدام:\n1. استخدام رسمي فقط\n2. عدم مشاركة البيانات\n3. الحفاظ على السرية\n4. الالتزام بالقوانين\n5. إبلاغ الإدارة عن المشاكل')}
function hasPermission(e,t){return currentUser?currentUser.permissions&&currentUser.permissions[e]&&currentUser.permissions[e].includes(t):permissions[currentUser.role]&&permissions[currentUser.role][e]&&permissions[currentUser.role][e].includes(t)}
function checkPermission(e,t){return hasPermission(e,t)||(showMessage('ليس لديك صلاحية','error'),!1)}
function updateUIForPermissions(){document.querySelectorAll('.nav-btn').forEach(e=>{const t=e.getAttribute('onclick').match(/showSection\('(\w+)'\)/)[1];'users'===t&&!hasPermission('users','read')?e.style.display='none':'signatures'===t&&!hasPermission('signatures','read')?e.style.display='none':'documents'===t&&!hasPermission('documents','read')&&(e.style.display='none')})}
function getHijriDate(){return new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{year:'numeric',month:'long',day:'numeric',weekday:'long'}).format(new Date)}
function addHijriDateToForm(){const e=document.createElement('div');e.className='hijri-date',e.innerHTML=`<div style="background:#f8f9fa;padding:1rem;border:1px solid #e0e0e0">التاريخ الهجري: ${getHijriDate()}</div>`,document.getElementById('formContent').insertBefore(e,document.getElementById('formContent').firstChild)}
function showMessage(e,t){const a=document.createElement('div');a.className=`message ${t} show`,a.innerHTML=`<div style="display:flex;align-items:center;gap:10px"><i class="fas ${' success'===t?'fa-check-circle':'fa-exclamation-circle'}"></i><span>${e}</span></div>`,a.style.cssText=`position:fixed;top:20px;right:20px;z-index:10000;padding:15px 20px;border-radius:8px;color:white;box-shadow:0 4px 12px rgba(0,0,0,0.3);${'success'===t?'background:#28a745;':'background:#dc3545;'}`,document.body.appendChild(a),setTimeout(()=>{a.remove()},5e3)}
window.onclick=function(e){document.querySelectorAll('.modal').forEach(t=>{e.target===t&&(t.style.display='none')})}
